%saturated curve
function toto
global Data Second Derivatives coef x Dcoef Graphic Event DiagDCoef Dcoef Data BottomSaturation Slope

%CPMC numbers
BottomSaturation=6000;  
Slope=2700; 
Data=[5.0292	13257.2775;6.096	13559.7613;7.3152	15755.0413;...
8.509	17316.5956;...
9.906	19262.3692;...
11.684	22705.2861;...
13.335	27076.6734;...
15.0292	34818.567;...
15.24	31955.5763;...
16.096	36999.7648;...
17.3152	39439.714;...
17.399	37827.0287;...
18.509	42228.6813;...
19.8628	45471.7972;...
19.906	44587.948;...
21.684	48099.1;...
22.86	51905.6626;...
23.335	51189.289;...
25.24	53759.319;...
26.4668	56790.9261;...
27.399	56097.677;...
29.8628	57735.299;...
31.2674	60287.8776;...
32.86	59506.535;...
36.4668	61194.139;...
38.1	61986.5112;...
41.2674	61947.093;...
48.1	62312.4926;...
50.038	62419.9351;...
60.038	62403.279;...
-9.14	6111.2;...
-5.5332	6463.04;...
-0.7326	7876.32;...
6.1	13883.52...
];

% %Vidar numbers
% BottomSaturation=13000;   
% Slope=2900; 
% Data=[;...
%  15.0292 15981;...
% 16.096	17294;...
% 17.3152	20000;...
% 18.509	21904;...
% 19.906	24922;...
% 21.684	29384;...
% 23.335	34828;...
% 25.24	39710;...
% 27.399	44309;...
% 29.8628	48783;...
% 32.86	52735;...
% 36.4668	56178;...
% 41.2674	59094;...
% 48.1	60678;...
% 60.038	61239;...
% 26.0292	42748;...
% 27.096	44632;...
% 28.3152	46864;...
% 29.509	48772;...
% 30.906	50478;...
% 32.684	52582;...
% 34.335	54442;...
% 36.24	56088;...
% 38.399	57613;...
% 40.8628	58673;...
% 43.86	59670;...
% 47.4668	60693;...
% 52.2674	61053;...
% 59.1	61290;...
% 71.038	61376;...
% 2.0292	12889;...
% 3.096	12889;...
% 4.3152	12889;...
% 5.509	12889;...
% 6.906	12889;...
% 8.684	13368;...
% 10.335	13969;...
% 12.24	15350;...
% 14.399	17220;...
% 16.8628	20646;...
% 19.86	26843;...
% 23.4668	35422;...
% 28.2674	45356;...
% 35.1	53978;...
% 47.038	59563;...
% 23.0292	36551;...
% 24.096	38703;...
% 25.3152	41383;...
% 26.509	43748;...
% 27.906	45066;...
% 29.684	48458;...
% 31.335	51619;...
% 33.24	53558;...
% 35.399	55412;...
% 37.8628	57051;...
% 40.86	58313;...
% 44.4668	59787;...
% 49.2674	60588;...
% 56.1	60958;...
% 68.038	61256;...
% ];

% slope=(coef(1)-BottomSaturation)*coef(4)/coef(3)/(1+coef(4)).^2
%     x=10:0.1:30;y=f(x,coef);[maxi,i0]=max(diff(y));y0=y(i0);x0=x(i0);
% figure;plot(Data(:,1),(finv(Data(:,2),coef)-x0)*Slope+y0,'.r');hold on;plot(Data(:,1),Data(:,2),'.b');

coef=[62000 20 5 0.9];
Dcoef=[10 0.01 0.01 0.0005];
    Graphic.MyFig=figure('units','normalized','position',[0 0 1 0.95]);
    Graphic.MyAxes=axes('units','normalized','position',[0.05 0.05 0.8 0.9]);
    button_y=0.9;
    for i=1:length(coef)
        Graphic.Plus(i)=uicontrol('style','pushbutton','string','+','units','normalized','position',[0.9 button_y 0.03 0.03],'CallBack',['global coef Dcoef Event; coef(',num2str(i),')=coef(',num2str(i),')+Dcoef(',num2str(i),');Event.Redraw=true;']);
        Graphic.Minus(i)=uicontrol('style','pushbutton','string','-','units','normalized','position',[0.9 button_y-0.03 0.03 0.03],'CallBack',['global coef Dcoef Event; coef(',num2str(i),')=coef(',num2str(i),')+Dcoef(',num2str(i),');Event.Redraw=true;']);    
        Graphic.Value(i)=uicontrol('style','edit','string',num2str(coef(i)),'units','normalized','position',[0.93 button_y-0.03 0.06 0.06],'CallBack',['global Graphic coef Event; coef(',num2str(i),')=str2num(get(Graphic.Value(',num2str(i),'),''string''));Event.Redraw=true;']);        
        button_y=button_y-0.1;
    end
    button_y=button_y-0.1;

    uicontrol('style','pushbutton','string','Optimize','units','normalized','position',[0.9 button_y 0.06 0.03],'CallBack','global Event; Event.Optimize=true;');button_y=button_y-0.1;
    uicontrol('style','text','string','Merit','units','normalized','position',[0.9 button_y 0.09 0.03],'background',[0.8 0.8 0.8]);
    Graphic.Merit=uicontrol('style','edit','string','0','units','normalized','position',[0.9 button_y-0.02 0.09 0.03],'background',[0.8 0.8 0.8]);
    button_y=button_y-0.1;
    uicontrol('style','pushbutton','string','stop','units','normalized','position',[0.9 button_y 0.06 0.03],'CallBack','global Event; Event.Stop=true;');;button_y=button_y-0.1;
    uicontrol('style','pushbutton','string','quit','units','normalized','position',[0.9 button_y 0.06 0.03],'CallBack','global Event; Event.Quit=true;');
    
x=[-50:150]/100*(max(Data(:,1))-min(Data(:,1)))+min(Data(:,1));
Event.Redraw=true;
DiagDCoef=diag(Dcoef);


Event.Stop=false;Event.Quit=false;Event.Optimize=false;
while (1)
    if Event.Optimize
        Optimize;
    end
    if Event.Redraw
        MyPlot;
    end
    if Event.Quit
        break;
    end
    pause(0.1);
end
        
%%
%Interpolation
global Image;
tic
X=BottomSaturation+500:100:coef(1)-500;
Y=finv(X,coef);
%figure;plot(X,Y);
Xi=reshape(Image.OriginalImage,1,prod(size(Image.OriginalImage)));
Yi=interp1(X,Y*Slope-BottomSaturation,Xi,'linear');
CorrectedImage=reshape(Yi,size(Image.OriginalImage,1),size(Image.OriginalImage,2));
toc
figure;imagesc(CorrectedImage);colormap(gray);

X=10:0.1:30;
Y=f(X,coef)
figure;plot(diff(Y)/0.1);
diff(Y)/0.1
%%

function Optimize
    global coef Graphic Event DiagDCoef Dcoef Data Slope BottomSaturation
    FormerMerit=1000;
    Event.Stop=false;
    Event.Optimize=false;
    
    while (1)
        NewMerit=Merit(coef);
        if (abs((FormerMerit-NewMerit))<1000)|(Event.Stop)
            break;
        end
        FormerMerit=NewMerit;
        set(Graphic.Merit,'string',num2str(NewMerit));
        
        Second=zeros(length(coef));
        for j=1:length(coef)
            Second(j,j)=(Merit(coef+2*DiagDCoef(j,:))-2*Merit(coef+DiagDCoef(j,:))+Merit(coef))/Dcoef(j)^2;
            for k=1:length(coef)
                if k~=j
                      Second(k,j)=(Merit(coef+DiagDCoef(k,:)+DiagDCoef(j,:))-Merit(coef+DiagDCoef(j,:))-Merit(coef+DiagDCoef(k,:))+Merit(coef))/Dcoef(j)/Dcoef(k)/4;
                  end
            end
            Derivatives(j)=(Merit(coef+DiagDCoef(j,:))-Merit(coef))/Dcoef(j);
        end
        DPara=(-Second\Derivatives')';
        coef=coef+DPara/1.5;
        pause(0.02);
        MyPlot
    end
    slope=(coef(1)-BottomSaturation)*coef(4)/coef(3)/(1+coef(4)).^2;
    x=10:0.1:30;y=f(x,coef);[maxi,i0]=max(diff(y));y0=y(i0);x0=x(i0);
figure;plot(Data(:,1),(finv(Data(:,2),coef)-x0)*Slope+y0,'.r');hold on;plot(Data(:,1),Data(:,2),'.b');

function y=f(x,coef)
    global BottomSaturation
    y=coef(1)+(BottomSaturation-coef(1))./(1+exp((x-coef(2))/coef(3))).^coef(4);

function x=finv(y,coef)
    global BottomSaturation
    x=coef(2)+coef(3)*log(((y-coef(1))/(BottomSaturation-coef(1))).^(-1/coef(4))-1);

function  result=Merit(coef)
    global Data
    result=sum((Data(:,2)-f(Data(:,1),coef)).^2);

function MyPlot
    global Data coef x Graphic Event
    Event.Redraw=false;
    plot(Data(:,1)+20,Data(:,2),'.r');hold on;
    plot(20+x,f(x,coef));hold off;
    for i=1:length(coef)
         set(Graphic.Value(i),'string',num2str(coef(i)));        
    end
